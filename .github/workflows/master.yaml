name: Deploy

on:
    push:
        branches:
            - 'master'

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        timeout-minutes: 10
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: User Node.js LTS
              uses: actions/setup-node@v2

            - name: Install pnpm
              uses: pnpm/action-setup@v2.2.4
              with:
                  run_install: false

            - name: Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint
              run: pnpm run lint

            - name: Linter Failed
              if: ${{ failure() }}
              uses: rtCamp/action-slack-notify@v2
              env:
                  SLACK_CHANNEL: general
                  SLACK_COLOR: ${{ job.status }}
                  SLACK_ICON: https://github.com/rtCamp.png?size=48
                  SLACK_MESSAGE: 'Linter failed, check [HERE](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
                  SLACK_TITLE: 'ðŸš¨ðŸš¨ðŸš¨ [SOFTLANCER.CO] MASTER BRANCH LINTER FAILED ðŸš¨ðŸš¨ðŸš¨'
                  SLACK_USERNAME: rtCamp
                  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

    deploy:
        environment: Production
        timeout-minutes: 15
        runs-on: ubuntu-latest
        needs: [lint]
        env:
            VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
            VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: User Node.js LTS
              uses: actions/setup-node@v2

            - name: Install pnpm
              uses: pnpm/action-setup@v2.2.4
              with:
                  run_install: false

            - name: Install Vercel CLI
              run: pnpm -g add vercel@canary

            - name: Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: Trigger Production Deployment
              run: vercel deploy -y --prod --token=${{ secrets.VERCEL_TOKEN }} > deployment-url.txt

            - name: Deployment Failure Alert
              if: ${{ failure() }}
              uses: rtCamp/action-slack-notify@v2
              env:
                  SLACK_CHANNEL: general
                  SLACK_COLOR: ${{ job.status }}
                  SLACK_ICON: https://github.com/rtCamp.png?size=48
                  SLACK_MESSAGE: 'production deployment failed, check [HERE](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
                  SLACK_TITLE: 'ðŸš¨ðŸš¨ðŸš¨ [SOFTLANCER.CO] MASTER BRANCH DEPLOYMENT FAILED ðŸš¨ðŸš¨ðŸš¨'
                  SLACK_USERNAME: rtCamp
                  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
